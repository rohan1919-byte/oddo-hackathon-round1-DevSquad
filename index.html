<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Skill Swap Platform</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React, ReactDOM, Babel CDNs -->
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div id="root"></div>
    <!-- React code will be added here -->
    <script type="text/babel">
// Initial sample data for the Skill Swap Platform
const initialData = {
  users: [
    {
      id: 1,
      name: "Alice Johnson",
      location: "New York, USA",
      photo: "https://randomuser.me/api/portraits/women/44.jpg",
      skillsOffered: ["Photoshop", "Excel", "Public Speaking"],
      skillsWanted: ["Python", "Guitar"],
      availability: "Weekends",
      isPublic: true,
      isBanned: false,
      createdAt: Date.now() - 10000000,
    },
    {
      id: 2,
      name: "Bob Smith",
      location: "London, UK",
      photo: "https://randomuser.me/api/portraits/men/32.jpg",
      skillsOffered: ["Guitar", "Cooking"],
      skillsWanted: ["Excel", "Public Speaking"],
      availability: "Evenings",
      isPublic: true,
      isBanned: false,
      createdAt: Date.now() - 9000000,
    },
    {
      id: 3,
      name: "Carol Lee",
      location: "Sydney, Australia",
      photo: "https://randomuser.me/api/portraits/women/68.jpg",
      skillsOffered: ["Python", "Yoga"],
      skillsWanted: ["Cooking", "Photoshop"],
      availability: "Weekdays",
      isPublic: true,
      isBanned: false,
      createdAt: Date.now() - 8000000,
    },
    // Admin user (hidden from public list)
    {
      id: 999,
      name: "Admin",
      location: "",
      photo: "",
      skillsOffered: [],
      skillsWanted: [],
      availability: "",
      isPublic: false,
      isBanned: false,
      isAdmin: true,
      createdAt: Date.now() - 12000000,
    },
  ],
  swaps: [
    {
      id: 1,
      fromUser: 1,
      toUser: 2,
      skillOffered: "Photoshop",
      skillWanted: "Guitar",
      status: "accepted", // pending, accepted, rejected, cancelled
      createdAt: Date.now() - 7000000,
      feedback: [
        {
          fromUser: 1,
          rating: 5,
          text: "Great experience! Learned a lot about guitar.",
        },
        {
          fromUser: 2,
          rating: 5,
          text: "Alice is a fantastic Photoshop teacher!",
        },
      ],
    },
    {
      id: 2,
      fromUser: 2,
      toUser: 3,
      skillOffered: "Cooking",
      skillWanted: "Yoga",
      status: "pending",
      createdAt: Date.now() - 6000000,
      feedback: [],
    },
  ],
  adminMessages: [
    {
      id: 1,
      text: "Welcome to the Skill Swap Platform! Please be respectful and report any inappropriate content.",
      createdAt: Date.now() - 5000000,
    },
  ],
  feedbackLogs: [], // For admin reports
};
// ... more React code will follow ...

// Utility: Load and save data to localStorage
function loadData() {
  const data = localStorage.getItem('skillSwapData');
  if (data) {
    try {
      return JSON.parse(data);
    } catch {
      return initialData;
    }
  }
  return initialData;
}
function saveData(data) {
  localStorage.setItem('skillSwapData', JSON.stringify(data));
}

// Main App Component
function App() {
  const [data, setData] = React.useState(loadData());
  const [currentUser, setCurrentUser] = React.useState(null); // null = not logged in
  const [token, setToken] = React.useState(localStorage.getItem('token'));
  const [tab, setTab] = React.useState('browse'); // browse, profile, swaps, admin
  const [notification, setNotification] = React.useState(null);
  const [adminMode, setAdminMode] = React.useState(false);

  // Persist data to localStorage
  React.useEffect(() => {
    saveData(data);
  }, [data]);

  // Helper: Get current user object (for backward compatibility)
  const currentUserFromData = data.users.find(u => u.id === currentUser?.id);
  const isAdmin = currentUser && currentUser.isAdmin;

  // Navigation tabs
  const tabs = [
    { key: 'browse', label: 'Browse Skills' },
    { key: 'profile', label: 'My Profile' },
    { key: 'swaps', label: 'My Swaps' },
  ];
  if (isAdmin) tabs.push({ key: 'admin', label: 'Admin Panel' });

  // Handle login with backend API
  async function handleLogin(email, password) {
    try {
      console.log('Attempting login with:', email);
      const response = await fetch('/api/users/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email, password }),
      });

      console.log('Login response status:', response.status);
      
      if (!response.ok) {
        const error = await response.json();
        console.error('Login error:', error);
        showNotification(error.message || 'Login failed', 'error');
        return;
      }

      const data = await response.json();
      console.log('Login successful:', data.user.name);
      setToken(data.token);
      setCurrentUser(data.user);
      setAdminMode(data.user.isAdmin || false);
      setTab('browse');
      localStorage.setItem('token', data.token);
      showNotification('Login successful!');
    } catch (error) {
      console.error('Login exception:', error);
      showNotification('Login failed. Please try again.', 'error');
    }
  }

  function handleLogout() {
    setCurrentUser(null);
    setToken(null);
    setAdminMode(false);
    setTab('browse');
    localStorage.removeItem('token');
    showNotification('Logged out successfully');
  }

  // Notification helper
  function showNotification(msg, type = 'info') {
    setNotification({ msg, type });
    setTimeout(() => setNotification(null), 3000);
  }

  // Main layout
  return (
    <div className="min-h-screen flex flex-col">
      {/* Header */}
      <header className="bg-blue-700 text-white p-4 flex items-center justify-between">
        <div className="flex items-center gap-2">
          <span className="font-bold text-xl">Skill Swap Platform</span>
          {isAdmin && (
            <span className="ml-2 px-2 py-1 bg-yellow-400 text-black rounded text-xs font-semibold">ADMIN</span>
          )}
        </div>
        <div>
          {currentUser ? (
            <div className="flex items-center gap-2">
              {currentUser.photo && (
                <img src={currentUser.photo} alt="profile" className="w-8 h-8 rounded-full border" />
              )}
              <span>{currentUser.name}</span>
              <button onClick={handleLogout} className="ml-2 px-3 py-1 bg-white text-blue-700 rounded hover:bg-blue-100">Logout</button>
            </div>
          ) : (
            <Login onLogin={handleLogin} />
          )}
        </div>
      </header>
      {/* Admin messages */}
      <div className="bg-yellow-100 text-yellow-800 text-center py-2 text-sm">
        {data.adminMessages.length > 0 && (
          <div>
            {data.adminMessages[data.adminMessages.length - 1].text}
          </div>
        )}
      </div>
      {/* Notification */}
      {notification && (
        <div className={`fixed top-4 right-4 z-50 px-4 py-2 rounded shadow-lg ${notification.type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`}>{notification.msg}</div>
      )}
      {/* Main content */}
      <div className="flex flex-1">
        {/* Sidebar navigation */}
        {currentUser && (
          <nav className="w-48 bg-gray-100 p-4 flex flex-col gap-2 border-r">
            {tabs.map(t => (
              <button
                key={t.key}
                className={`text-left px-3 py-2 rounded hover:bg-blue-200 ${tab === t.key ? 'bg-blue-500 text-white' : ''}`}
                onClick={() => setTab(t.key)}
              >
                {t.label}
              </button>
            ))}
          </nav>
        )}
        {/* Main panel */}
        <main className="flex-1 p-6">
          {!currentUser && (
            <div className="text-center text-gray-600 mt-10">Please log in to use the platform.</div>
          )}
                  {currentUser && tab === 'profile' && (
          <Profile
            user={currentUser}
            token={token}
            showNotification={showNotification}
            onProfileUpdate={(updatedUser) => setCurrentUser(updatedUser)}
          />
        )}
          {currentUser && tab === 'browse' && (
            <Browse
              currentUser={currentUser}
              token={token}
              showNotification={showNotification}
            />
          )}
          {currentUser && tab === 'swaps' && (
            <Swaps
              currentUser={currentUser}
              token={token}
              showNotification={showNotification}
            />
          )}
          {currentUser && isAdmin && tab === 'admin' && (
            <AdminPanel
              data={data}
              setData={setData}
              showNotification={showNotification}
            />
          )}
        </main>
      </div>
      {/* Footer */}
      <footer className="bg-gray-200 text-center py-2 text-xs text-gray-600">&copy; {new Date().getFullYear()} Skill Swap Platform</footer>
    </div>
  );
}

// Login component
function Login({ onLogin }) {
  const [email, setEmail] = React.useState('');
  const [password, setPassword] = React.useState('');
  const [isLoading, setIsLoading] = React.useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!email || !password) return;
    
    setIsLoading(true);
    await onLogin(email, password);
    setIsLoading(false);
  };

  return (
    <form onSubmit={handleSubmit} className="flex gap-2">
      <input
        type="email"
        placeholder="Email"
        value={email}
        onChange={(e) => setEmail(e.target.value)}
        className="px-2 py-1 rounded border text-black"
        required
      />
      <input
        type="password"
        placeholder="Password"
        value={password}
        onChange={(e) => setPassword(e.target.value)}
        className="px-2 py-1 rounded border text-black"
        required
      />
      <button 
        type="submit"
        className={`px-3 py-1 bg-white text-blue-700 rounded hover:bg-blue-100 ${
          isLoading ? 'opacity-50 cursor-not-allowed' : ''
        }`}
        disabled={isLoading}
      >
        {isLoading ? 'Logging in...' : 'Login'}
      </button>
    </form>
  );
}

// Profile Component
function Profile({ user, token, showNotification, onProfileUpdate }) {
  const [editMode, setEditMode] = React.useState(false);
  const [form, setForm] = React.useState({ ...user });
  const [isLoading, setIsLoading] = React.useState(false);
  const [imageFile, setImageFile] = React.useState(null);
  const [imagePreview, setImagePreview] = React.useState(null);

  function handleChange(e) {
    const { name, value } = e.target;
    setForm(f => ({ ...f, [name]: value }));
  }

  function handleArrayChange(name, value) {
    setForm(f => ({ ...f, [name]: value.split(',').map(s => s.trim()).filter(Boolean) }));
  }

  function handleImageChange(e) {
    const file = e.target.files[0];
    if (file) {
      setImageFile(file);
      const reader = new FileReader();
      reader.onload = (e) => setImagePreview(e.target.result);
      reader.readAsDataURL(file);
    }
  }

  async function handleSave() {
    if (!form.name.trim()) {
      showNotification('Name is required', 'error');
      return;
    }

    setIsLoading(true);
    try {
      // First upload image if selected
      let photoUrl = form.photo;
      if (imageFile) {
        const formData = new FormData();
        formData.append('photo', imageFile);
        
        const uploadResponse = await fetch('/api/upload-photo', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });

        if (uploadResponse.ok) {
          const uploadData = await uploadResponse.json();
          photoUrl = uploadData.photoUrl;
        } else {
          showNotification('Failed to upload image', 'error');
          setIsLoading(false);
          return;
        }
      }

      // Update profile
      const response = await fetch('/api/users/profile', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          ...form,
          photo: photoUrl
        })
      });

      if (!response.ok) {
        const error = await response.json();
        showNotification(error.message || 'Failed to update profile', 'error');
        return;
      }

      const updatedUser = await response.json();
      onProfileUpdate(updatedUser.user);
      setEditMode(false);
      setImageFile(null);
      setImagePreview(null);
      showNotification('Profile updated successfully!');
    } catch (error) {
      showNotification('Failed to update profile. Please try again.', 'error');
    } finally {
      setIsLoading(false);
    }
  }

  async function handleTogglePublic() {
    setIsLoading(true);
    try {
      const response = await fetch('/api/users/profile', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          ...form,
          isPublic: !user.isPublic
        })
      });

      if (!response.ok) {
        const error = await response.json();
        showNotification(error.message || 'Failed to update profile visibility', 'error');
        return;
      }

      const updatedUser = await response.json();
      onProfileUpdate(updatedUser.user);
      showNotification(`Profile is now ${updatedUser.user.isPublic ? 'public' : 'private'}`);
    } catch (error) {
      showNotification('Failed to update profile visibility. Please try again.', 'error');
    } finally {
      setIsLoading(false);
    }
  }

  return (
    <div className="max-w-2xl mx-auto bg-white shadow-lg rounded-lg p-6">
      <div className="flex items-center gap-6 mb-6">
        <div className="relative">
          <img 
            src={imagePreview || form.photo || 'https://via.placeholder.com/120x120?text=Profile'} 
            alt="profile" 
            className="w-24 h-24 rounded-full border-4 border-gray-200 object-cover" 
          />
          {editMode && (
            <label className="absolute bottom-0 right-0 bg-blue-600 text-white p-2 rounded-full cursor-pointer hover:bg-blue-700 transition-colors">
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
              <input 
                type="file" 
                accept="image/*" 
                onChange={handleImageChange} 
                className="hidden" 
              />
            </label>
          )}
        </div>
        <div>
          <div className="font-bold text-2xl text-gray-800">{user.name}</div>
          <div className="text-gray-600">{user.location || 'Location not set'}</div>
          <div className="flex items-center gap-2 mt-2">
            <span className={`px-3 py-1 rounded-full text-xs font-semibold ${
              user.isPublic ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
            }`}>
              {user.isPublic ? 'Public Profile' : 'Private Profile'}
            </span>
          </div>
        </div>
      </div>

      {editMode ? (
        <div className="space-y-4">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Name *</label>
              <input 
                name="name" 
                value={form.name} 
                onChange={handleChange} 
                className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                placeholder="Enter your name"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Location</label>
              <input 
                name="location" 
                value={form.location} 
                onChange={handleChange} 
                className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                placeholder="City, Country"
              />
            </div>
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Skills Offered (comma separated)</label>
            <input 
              name="skillsOffered" 
              value={form.skillsOffered.join(', ')} 
              onChange={e => handleArrayChange('skillsOffered', e.target.value)} 
              className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
              placeholder="e.g., Cooking, Programming, Yoga"
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Skills Wanted (comma separated)</label>
            <input 
              name="skillsWanted" 
              value={form.skillsWanted.join(', ')} 
              onChange={e => handleArrayChange('skillsWanted', e.target.value)} 
              className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
              placeholder="e.g., Guitar, Photography, Spanish"
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Availability</label>
            <input 
              name="availability" 
              value={form.availability} 
              onChange={handleChange} 
              className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
              placeholder="e.g., Weekends, Evenings, Flexible"
            />
          </div>

          <div className="flex items-center gap-4 pt-4 border-t">
            <div className="flex items-center gap-2">
              <input 
                type="checkbox" 
                id="isPublic" 
                checked={form.isPublic} 
                onChange={(e) => setForm(f => ({ ...f, isPublic: e.target.checked }))}
                className="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
              />
              <label htmlFor="isPublic" className="text-sm font-medium text-gray-700">
                Make my profile public
              </label>
            </div>
          </div>

          <div className="flex gap-3 pt-4">
            <button 
              className={`px-6 py-2 rounded-lg font-medium transition-colors ${
                isLoading 
                  ? 'bg-gray-400 text-white cursor-not-allowed' 
                  : 'bg-blue-600 text-white hover:bg-blue-700'
              }`} 
              onClick={handleSave}
              disabled={isLoading}
            >
              {isLoading ? 'Saving...' : 'Save Changes'}
            </button>
            <button 
              className="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-400 transition-colors" 
              onClick={() => {
                setEditMode(false);
                setForm({ ...user });
                setImageFile(null);
                setImagePreview(null);
              }}
            >
              Cancel
            </button>
          </div>
        </div>
      ) : (
        <div className="space-y-4">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <span className="text-sm font-medium text-gray-500">Name</span>
              <div className="text-gray-900">{user.name}</div>
            </div>
            <div>
              <span className="text-sm font-medium text-gray-500">Location</span>
              <div className="text-gray-900">{user.location || <span className="text-gray-400 italic">Not set</span>}</div>
            </div>
          </div>
          
          <div>
            <span className="text-sm font-medium text-gray-500">Skills Offered</span>
            <div className="text-gray-900">
              {user.skillsOffered.length > 0 ? (
                <div className="flex flex-wrap gap-2 mt-1">
                  {user.skillsOffered.map((skill, index) => (
                    <span key={index} className="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
                      {skill}
                    </span>
                  ))}
                </div>
              ) : (
                <span className="text-gray-400 italic">No skills offered</span>
              )}
            </div>
          </div>
          
          <div>
            <span className="text-sm font-medium text-gray-500">Skills Wanted</span>
            <div className="text-gray-900">
              {user.skillsWanted.length > 0 ? (
                <div className="flex flex-wrap gap-2 mt-1">
                  {user.skillsWanted.map((skill, index) => (
                    <span key={index} className="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">
                      {skill}
                    </span>
                  ))}
                </div>
              ) : (
                <span className="text-gray-400 italic">No skills wanted</span>
              )}
            </div>
          </div>
          
          <div>
            <span className="text-sm font-medium text-gray-500">Availability</span>
            <div className="text-gray-900">{user.availability || <span className="text-gray-400 italic">Not set</span>}</div>
          </div>

          <div className="flex gap-3 pt-4 border-t">
            <button 
              className="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors" 
              onClick={() => setEditMode(true)}
            >
              Edit Profile
            </button>
            <button 
              className={`px-6 py-2 rounded-lg font-medium transition-colors ${
                isLoading 
                  ? 'bg-gray-400 text-white cursor-not-allowed' 
                  : user.isPublic 
                    ? 'bg-red-600 text-white hover:bg-red-700' 
                    : 'bg-green-600 text-white hover:bg-green-700'
              }`} 
              onClick={handleTogglePublic}
              disabled={isLoading}
            >
              {isLoading ? 'Updating...' : (user.isPublic ? 'Make Private' : 'Make Public')}
            </button>
          </div>
        </div>
      )}
    </div>
  );
}

// Browse component
function Browse({ currentUser, token, showNotification }) {
  const [searchTerm, setSearchTerm] = React.useState('');
  const [users, setUsers] = React.useState([]);
  const [swaps, setSwaps] = React.useState([]);
  const [isLoading, setIsLoading] = React.useState(true);

  // Load public users and swaps
  React.useEffect(() => {
    loadData();
  }, []);

  async function loadData() {
    try {
      // Load public users
      const usersResponse = await fetch(`/api/users/public?search=${searchTerm}`);
      const usersData = await usersResponse.json();
      setUsers(usersData);

      // Load user's swaps
      const swapsResponse = await fetch('/api/swaps/my-swaps', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      const swapsData = await swapsResponse.json();
      setSwaps([...swapsData.incoming, ...swapsData.outgoing, ...swapsData.accepted]);
    } catch (error) {
      console.error('Error loading data:', error);
      showNotification('Failed to load data', 'error');
    } finally {
      setIsLoading(false);
    }
  }

  // Filter users by search term (skill)
  const filteredUsers = users
    .filter(u => u.id !== currentUser.id)
    .filter(u => u.isPublic && !u.isBanned)
    .filter(u => {
      if (!searchTerm.trim()) return true;
      const term = searchTerm.toLowerCase();
      return (
        u.skillsOffered.some(s => s.toLowerCase().includes(term)) ||
        u.skillsWanted.some(s => s.toLowerCase().includes(term))
      );
    });

  // Check if a swap request is already pending or accepted
  function hasPendingOrAcceptedSwap(targetUserId) {
    return swaps.some(
      s =>
        ((s.fromUserId === currentUser.id && s.toUserId === targetUserId) ||
          (s.fromUserId === targetUserId && s.toUserId === currentUser.id)) &&
        (s.status === 'pending' || s.status === 'accepted')
    );
  }

  // Send swap request
  async function sendSwapRequest(targetUser) {
    try {
      // Find a matching skill pair
      const offered = currentUser.skillsOffered.find(skill => targetUser.skillsWanted.includes(skill));
      const wanted = currentUser.skillsWanted.find(skill => targetUser.skillsOffered.includes(skill));
      
      if (!offered || !wanted) {
        showNotification('No matching skills for swap!', 'error');
        return;
      }

      // Prevent duplicate requests
      if (hasPendingOrAcceptedSwap(targetUser.id)) {
        showNotification('Swap request already exists!', 'error');
        return;
      }

      const response = await fetch('/api/swaps', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          toUserId: targetUser.id,
          skillOffered: offered,
          skillWanted: wanted
        })
      });

      if (!response.ok) {
        const error = await response.json();
        showNotification(error.message || 'Failed to send swap request', 'error');
        return;
      }

      showNotification('Swap request sent successfully!');
      loadData(); // Reload data to show updated state
    } catch (error) {
      console.error('Error sending swap request:', error);
      showNotification('Failed to send swap request', 'error');
    }
  }

  return (
    <div className="max-w-3xl mx-auto">
      <div className="mb-4 flex gap-2 items-center">
        <input
          className="w-full border rounded px-3 py-2"
          placeholder="Search by skill (e.g., Excel, Photoshop)"
          value={searchTerm}
          onChange={e => setSearchTerm(e.target.value)}
          onKeyPress={e => e.key === 'Enter' && loadData()}
        />
        <button 
          onClick={loadData}
          className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
        >
          Search
        </button>
      </div>
      
      {isLoading ? (
        <div className="text-center text-gray-500 mt-8">Loading users...</div>
      ) : filteredUsers.length === 0 ? (
        <div className="text-center text-gray-500 mt-8">No public profiles found for your search.</div>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {filteredUsers.map(u => (
            <div key={u.id} className="bg-white shadow rounded p-4 flex flex-col gap-2">
              <div className="flex items-center gap-3">
                <img src={u.photo || 'https://via.placeholder.com/60'} alt="profile" className="w-12 h-12 rounded-full border" />
                <div>
                  <div className="font-bold">{u.name}</div>
                  <div className="text-xs text-gray-500">{u.location}</div>
                </div>
              </div>
              <div><span className="font-medium">Skills Offered:</span> {u.skillsOffered.join(', ') || <span className="text-gray-400">(none)</span>}</div>
              <div><span className="font-medium">Skills Wanted:</span> {u.skillsWanted.join(', ') || <span className="text-gray-400">(none)</span>}</div>
              <div><span className="font-medium">Availability:</span> {u.availability || <span className="text-gray-400">(not set)</span>}</div>
              <button
                className={`mt-2 px-4 py-1 rounded ${hasPendingOrAcceptedSwap(u.id) ? 'bg-gray-400 text-white cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}`}
                disabled={hasPendingOrAcceptedSwap(u.id)}
                onClick={() => sendSwapRequest(u)}
              >
                {hasPendingOrAcceptedSwap(u.id) ? 'Swap Requested' : 'Request Swap'}
              </button>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

// Swaps Component
function Swaps({ currentUser, token, showNotification }) {
  const [swaps, setSwaps] = React.useState({ incoming: [], outgoing: [], accepted: [] });
  const [isLoading, setIsLoading] = React.useState(true);

  // Load user's swaps
  React.useEffect(() => {
    loadSwaps();
  }, []);

  async function loadSwaps() {
    try {
      const response = await fetch('/api/swaps/my-swaps', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });
      
      if (!response.ok) {
        throw new Error('Failed to load swaps');
      }
      
      const data = await response.json();
      setSwaps(data);
    } catch (error) {
      console.error('Error loading swaps:', error);
      showNotification('Failed to load swaps', 'error');
    } finally {
      setIsLoading(false);
    }
  }

  // Helper to get user by ID
  async function getUser(id) {
    try {
      const response = await fetch(`/api/users/${id}`);
      if (response.ok) {
        return await response.json();
      }
    } catch (error) {
      console.error('Error fetching user:', error);
    }
    return { name: 'Unknown User' };
  }

  // Accept/reject swap
  async function handleSwapAction(swapId, action) {
    try {
      const response = await fetch(`/api/swaps/${swapId}/${action}`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!response.ok) {
        const error = await response.json();
        showNotification(error.message || `Failed to ${action} swap`, 'error');
        return;
      }

      showNotification(`Swap ${action}!`);
      loadSwaps(); // Reload swaps
    } catch (error) {
      console.error('Error updating swap:', error);
      showNotification(`Failed to ${action} swap`, 'error');
    }
  }

  // Delete outgoing pending swap
  async function handleDeleteSwap(swapId) {
    try {
      const response = await fetch(`/api/swaps/${swapId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!response.ok) {
        const error = await response.json();
        showNotification(error.message || 'Failed to delete swap', 'error');
        return;
      }

      showNotification('Swap request deleted.');
      loadSwaps(); // Reload swaps
    } catch (error) {
      console.error('Error deleting swap:', error);
      showNotification('Failed to delete swap', 'error');
    }
  }

  // Leave feedback
  async function handleFeedback(swapId, rating, text) {
    try {
      const response = await fetch(`/api/swaps/${swapId}/feedback`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ rating, text })
      });

      if (!response.ok) {
        const error = await response.json();
        showNotification(error.message || 'Failed to submit feedback', 'error');
        return;
      }

      showNotification('Feedback submitted!');
      loadSwaps(); // Reload swaps
    } catch (error) {
      console.error('Error submitting feedback:', error);
      showNotification('Failed to submit feedback', 'error');
    }
  }

  // Feedback form state
  const [feedbackState, setFeedbackState] = React.useState({});

  function FeedbackForm({ swap }) {
    const existing = swap.feedback.find(f => f.fromUser === currentUser.id) || { rating: 5, text: '' };
    const [rating, setRating] = React.useState(existing.rating);
    const [text, setText] = React.useState(existing.text);
    return (
      <div className="flex flex-col gap-2 mt-2">
        <div className="flex items-center gap-1">
          {[1,2,3,4,5].map(star => (
            <button
              key={star}
              className={`text-xl ${star <= rating ? 'text-yellow-400' : 'text-gray-300'}`}
              onClick={() => setRating(star)}
              type="button"
            >★</button>
          ))}
        </div>
        <textarea
          className="w-full border rounded px-2 py-1"
          placeholder="Leave feedback..."
          value={text}
          onChange={e => setText(e.target.value)}
        />
        <button
          className="px-3 py-1 bg-blue-600 text-white rounded"
          onClick={() => handleFeedback(swap.id, rating, text)}
        >Submit</button>
      </div>
    );
  }

  return (
    <div className="max-w-3xl mx-auto">
      <h2 className="text-xl font-bold mb-4">My Swaps</h2>
      {/* Incoming requests */}
      <div className="mb-6">
        <h3 className="font-semibold mb-2">Incoming Requests</h3>
        {incoming.length === 0 ? (
          <div className="text-gray-500">No incoming requests.</div>
        ) : (
          <div className="space-y-3">
            {incoming.map(s => (
              <div key={s.id} className="bg-white shadow rounded p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                <div>
                  <div><span className="font-medium">From:</span> {getUser(s.fromUser).name}</div>
                  <div><span className="font-medium">Skill Offered:</span> {s.skillOffered}</div>
                  <div><span className="font-medium">Skill Wanted:</span> {s.skillWanted}</div>
                </div>
                <div className="flex gap-2 mt-2 md:mt-0">
                  <button className="px-3 py-1 bg-green-600 text-white rounded" onClick={() => handleSwapAction(s.id, 'accepted')}>Accept</button>
                  <button className="px-3 py-1 bg-red-500 text-white rounded" onClick={() => handleSwapAction(s.id, 'rejected')}>Reject</button>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
      {/* Outgoing requests */}
      <div className="mb-6">
        <h3 className="font-semibold mb-2">Outgoing Requests</h3>
        {outgoing.length === 0 ? (
          <div className="text-gray-500">No outgoing requests.</div>
        ) : (
          <div className="space-y-3">
            {outgoing.map(s => (
              <div key={s.id} className="bg-white shadow rounded p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                <div>
                  <div><span className="font-medium">To:</span> {getUser(s.toUser).name}</div>
                  <div><span className="font-medium">Skill Offered:</span> {s.skillOffered}</div>
                  <div><span className="font-medium">Skill Wanted:</span> {s.skillWanted}</div>
                </div>
                <button className="px-3 py-1 bg-gray-400 text-white rounded" onClick={() => handleDeleteSwap(s.id)}>Delete</button>
              </div>
            ))}
          </div>
        )}
      </div>
      {/* Accepted swaps */}
      <div className="mb-6">
        <h3 className="font-semibold mb-2">Accepted Swaps</h3>
        {accepted.length === 0 ? (
          <div className="text-gray-500">No accepted swaps yet.</div>
        ) : (
          <div className="space-y-3">
            {accepted.map(s => (
              <div key={s.id} className="bg-white shadow rounded p-4">
                <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                  <div>
                    <div><span className="font-medium">With:</span> {getUser(s.fromUser === currentUser.id ? s.toUser : s.fromUser).name}</div>
                    <div><span className="font-medium">Skill Offered:</span> {s.skillOffered}</div>
                    <div><span className="font-medium">Skill Wanted:</span> {s.skillWanted}</div>
                  </div>
                  <div>
                    {/* Feedback */}
                    {s.feedback.some(f => f.fromUser === currentUser.id) ? (
                      <div className="text-green-600 font-semibold">Feedback submitted</div>
                    ) : (
                      <FeedbackForm swap={s} />
                    )}
                  </div>
                </div>
                {/* Show all feedback */}
                {s.feedback.length > 0 && (
                  <div className="mt-2 text-sm text-gray-600">
                    <div className="font-medium">Feedback:</div>
                    {s.feedback.map((f, i) => (
                      <div key={i} className="flex items-center gap-2">
                        <span className="font-bold">{getUser(f.fromUser).name}:</span>
                        <span>{'★'.repeat(f.rating)}{'☆'.repeat(5 - f.rating)}</span>
                        <span>{f.text}</span>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

// Admin Panel Component
function AdminPanel({ data, setData, showNotification }) {
  const [message, setMessage] = React.useState('');
  const [reportType, setReportType] = React.useState('json');

  // Ban user
  function banUser(userId) {
    setData(prev => ({
      ...prev,
      users: prev.users.map(u => u.id === userId ? { ...u, isBanned: true, isPublic: false } : u),
      swaps: prev.swaps.filter(s => s.fromUser !== userId && s.toUser !== userId),
    }));
    showNotification('User banned and their swaps removed.');
  }

  // Remove inappropriate skill (set to [removed])
  function removeSkill(userId, skill, type) {
    setData(prev => ({
      ...prev,
      users: prev.users.map(u =>
        u.id === userId
          ? {
              ...u,
              [type]: u[type].map(s => (s === skill ? '[removed]' : s)),
            }
          : u
      ),
    }));
    showNotification('Skill marked as removed.');
  }

  // Send platform-wide message
  function sendMessage() {
    if (!message.trim()) return;
    setData(prev => ({
      ...prev,
      adminMessages: [
        ...prev.adminMessages,
        { id: Date.now(), text: message, createdAt: Date.now() },
      ],
    }));
    setMessage('');
    showNotification('Message sent to all users!');
  }

  // Download report
  function downloadReport() {
    let content = '';
    let filename = 'report.' + reportType;
    if (reportType === 'json') {
      content = JSON.stringify({
        users: data.users,
        swaps: data.swaps,
        feedbackLogs: data.feedbackLogs,
        stats: {
          totalUsers: data.users.length,
          totalSwaps: data.swaps.length,
          pendingSwaps: data.swaps.filter(s => s.status === 'pending').length,
          acceptedSwaps: data.swaps.filter(s => s.status === 'accepted').length,
        },
      }, null, 2);
    } else {
      // CSV
      const userRows = data.users.map(u => `${u.id},${u.name},${u.location},${u.isBanned}`);
      const swapRows = data.swaps.map(s => `${s.id},${s.fromUser},${s.toUser},${s.skillOffered},${s.skillWanted},${s.status}`);
      const feedbackRows = (data.feedbackLogs || []).map(f => `${f.swapId},${f.fromUser},${f.rating},${f.text.replace(/,/g, ';')}`);
      content = 'Users\nID,Name,Location,Banned\n' + userRows.join('\n') +
        '\n\nSwaps\nID,From,To,SkillOffered,SkillWanted,Status\n' + swapRows.join('\n') +
        '\n\nFeedback\nSwapID,FromUser,Rating,Text\n' + feedbackRows.join('\n');
    }
    const blob = new Blob([content], { type: reportType === 'json' ? 'application/json' : 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
    showNotification('Report downloaded!');
  }

  // List of users (excluding admin)
  const users = data.users.filter(u => !u.isAdmin);

  // List of all swaps
  const allSwaps = data.swaps;

  return (
    <div className="max-w-4xl mx-auto">
      <h2 className="text-xl font-bold mb-4">Admin Panel</h2>
      {/* Platform message */}
      <div className="mb-6 bg-yellow-50 p-4 rounded">
        <div className="font-semibold mb-2">Send Platform-wide Message</div>
        <div className="flex gap-2">
          <input
            className="flex-1 border rounded px-2 py-1"
            placeholder="Enter message..."
            value={message}
            onChange={e => setMessage(e.target.value)}
          />
          <button className="px-3 py-1 bg-blue-600 text-white rounded" onClick={sendMessage}>Send</button>
        </div>
      </div>
      {/* User management */}
      <div className="mb-6">
        <div className="font-semibold mb-2">User Management</div>
        <div className="overflow-x-auto">
          <table className="min-w-full text-sm border">
            <thead>
              <tr className="bg-gray-100">
                <th className="p-2 border">Name</th>
                <th className="p-2 border">Location</th>
                <th className="p-2 border">Skills Offered</th>
                <th className="p-2 border">Skills Wanted</th>
                <th className="p-2 border">Availability</th>
                <th className="p-2 border">Status</th>
                <th className="p-2 border">Actions</th>
              </tr>
            </thead>
            <tbody>
              {users.map(u => (
                <tr key={u.id} className={u.isBanned ? 'bg-red-100' : ''}>
                  <td className="p-2 border">{u.name}</td>
                  <td className="p-2 border">{u.location}</td>
                  <td className="p-2 border">
                    {u.skillsOffered.map(skill => (
                      <span key={skill} className="inline-block bg-blue-100 rounded px-2 py-0.5 m-0.5">
                        {skill} {skill !== '[removed]' && <button className="text-xs text-red-500 ml-1" onClick={() => removeSkill(u.id, skill, 'skillsOffered')}>✕</button>}
                      </span>
                    ))}
                  </td>
                  <td className="p-2 border">
                    {u.skillsWanted.map(skill => (
                      <span key={skill} className="inline-block bg-green-100 rounded px-2 py-0.5 m-0.5">
                        {skill} {skill !== '[removed]' && <button className="text-xs text-red-500 ml-1" onClick={() => removeSkill(u.id, skill, 'skillsWanted')}>✕</button>}
                      </span>
                    ))}
                  </td>
                  <td className="p-2 border">{u.availability}</td>
                  <td className="p-2 border">{u.isBanned ? <span className="text-red-600 font-bold">BANNED</span> : 'Active'}</td>
                  <td className="p-2 border">
                    {!u.isBanned && <button className="px-2 py-1 bg-red-500 text-white rounded" onClick={() => banUser(u.id)}>Ban</button>}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
      {/* Swaps overview */}
      <div className="mb-6">
        <div className="font-semibold mb-2">All Swaps</div>
        <div className="overflow-x-auto">
          <table className="min-w-full text-sm border">
            <thead>
              <tr className="bg-gray-100">
                <th className="p-2 border">From</th>
                <th className="p-2 border">To</th>
                <th className="p-2 border">Skill Offered</th>
                <th className="p-2 border">Skill Wanted</th>
                <th className="p-2 border">Status</th>
                <th className="p-2 border">Created</th>
              </tr>
            </thead>
            <tbody>
              {allSwaps.map(s => (
                <tr key={s.id}>
                  <td className="p-2 border">{data.users.find(u => u.id === s.fromUser)?.name}</td>
                  <td className="p-2 border">{data.users.find(u => u.id === s.toUser)?.name}</td>
                  <td className="p-2 border">{s.skillOffered}</td>
                  <td className="p-2 border">{s.skillWanted}</td>
                  <td className="p-2 border">{s.status}</td>
                  <td className="p-2 border">{new Date(s.createdAt).toLocaleString()}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
      {/* Download report */}
      <div className="mb-6">
        <div className="font-semibold mb-2">Download Reports</div>
        <div className="flex gap-2 items-center">
          <select className="border rounded px-2 py-1" value={reportType} onChange={e => setReportType(e.target.value)}>
            <option value="json">JSON</option>
            <option value="csv">CSV</option>
          </select>
          <button className="px-3 py-1 bg-blue-600 text-white rounded" onClick={downloadReport}>Download</button>
        </div>
      </div>
    </div>
  );
}

// At the end, render the App
ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html> 